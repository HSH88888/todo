<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dark Todo Master (3-Wheel Date)</title>
    <style>
        :root {
            /* --- ë‹¤í¬ í…Œë§ˆ ì»¬ëŸ¬ --- */
            --bg-color: #2b2e33;
            --box-bg: #2b2e33;
            --text-main: #e0e5ec;
            --text-sub: #9baacf;
            --accent-color: #ff6b6b;   /* ì½”ë„ ì˜¤ë Œì§€ */
            
            /* ë‰´ëª¨í”¼ì¦˜ ê·¸ë¦¼ì */
            --shadow-light: #35393f;
            --shadow-dark: #212327;
            
            --danger-color: #ff4757;
            --success-color: #2ed573;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh; height: 100dvh;
            overflow: hidden;
            user-select: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box;
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            background: var(--box-bg);
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); 
        }

        /* --- í—¤ë” --- */
        .header {
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--box-bg); z-index: 10; flex-shrink: 0;
        }
        .app-title { font-size: 20px; font-weight: 700; color: var(--text-main); }
        .header-controls { display: flex; gap: 15px; }

        .neu-btn {
            background: var(--bg-color); border-radius: 12px; border: none;
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            color: var(--text-sub); padding: 10px 15px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;
        }
        .neu-btn:active {
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
            color: var(--accent-color);
        }
        .neu-btn.icon-only { padding: 10px; font-size: 18px; width: 42px; height: 42px; justify-content: center; }
        
        .user-status-dot { width: 8px; height: 8px; background: #555; border-radius: 50%; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5); }
        .user-status-dot.active { background: var(--accent-color); box-shadow: 0 0 5px var(--accent-color); }

        /* --- ë‚ ì§œ ì„ íƒ ì˜ì—­ (3ë‹¨ íœ ) --- */
        .date-picker-area {
            height: 150px; background: var(--bg-color); position: relative; overflow: hidden;
            margin-bottom: 5px; flex-shrink: 0;
            /* ìœ„ì•„ë˜ í˜ì´ë“œ ë§ˆìŠ¤í¬ */
            mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
            
            display: flex; /* ê°€ë¡œ ë°°ì¹˜ */
            justify-content: center;
        }
        
        /* ê°œë³„ íœ  ì»¬ëŸ¼ */
        .wheel-col {
            flex: 1; /* 3ë“±ë¶„ */
            height: 100%;
            overflow-y: scroll; scroll-snap-type: y mandatory;
            scrollbar-width: none;
            padding: 55px 0; /* ì¤‘ì•™ ì •ë ¬ìš© íŒ¨ë”© */
            text-align: center;
        }
        .wheel-col::-webkit-scrollbar { display: none; }

        .wheel-item {
            height: 40px; display: flex; justify-content: center; align-items: center;
            font-size: 16px; color: var(--text-sub); scroll-snap-align: center;
            transform-origin: center center; transition: all 0.2s; opacity: 0.4;
        }
        .wheel-item.selected-visual {
            color: var(--accent-color); opacity: 1; font-weight: 700; font-size: 19px;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }

        /* ì¤‘ì•™ í•˜ì´ë¼ì´íŠ¸ ë°” */
        .highlight-bar {
            position: absolute; top: 50%; left: 0; right: 0; height: 36px; margin-top: -18px;
            background: rgba(0,0,0,0.03); pointer-events: none; z-index: 0;
        }

        /* --- ìŠ¤ì¼€ì¤„ ë¦¬ìŠ¤íŠ¸ --- */
        .schedule-list { 
            flex: 1; overflow-y: auto; padding: 10px 20px; padding-bottom: 80px; 
        }
        .schedule-list::-webkit-scrollbar { display: none; }

        .time-slot { 
            display: flex; align-items: center; padding: 18px 20px; margin-bottom: 12px;
            border-radius: 16px; background: var(--bg-color);
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            cursor: pointer; transition: transform 0.1s;
        }
        .time-slot:active { transform: scale(0.98); box-shadow: 2px 2px 5px var(--shadow-dark), -2px -2px 5px var(--shadow-light); }
        
        .time-label { width: 60px; font-weight: 700; color: var(--text-main); font-size: 16px; font-variant-numeric: tabular-nums; }
        .task-content { flex: 1; color: var(--text-sub); font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-content.filled { color: var(--accent-color); font-weight: 600; }
        .task-content.empty { font-style: italic; opacity: 0.5; font-size: 13px; }

        /* --- ëª¨ë‹¬ ê³µí†µ --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 100;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: var(--bg-color); border-radius: 24px; width: 85%; max-width: 340px;
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            padding: 25px; display: flex; flex-direction: column; color: var(--text-main);
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 85vh; overflow-y: auto;
        }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* ëª¨ë‹¬ ë‚´ë¶€ ìš”ì†Œë“¤ (ê¸°ì¡´ ìœ ì§€) */
        .time-setter-area { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .time-display { 
            font-size: 32px; font-weight: 800; color: var(--text-main); 
            display: flex; align-items: center; gap: 5px; margin-bottom: 15px;
        }
        .time-display span.active { color: var(--accent-color); text-shadow: 0 0 10px rgba(255,107,107,0.4); }
        
        .minute-wheel-wrapper {
            width: 100%; height: 60px; overflow-x: scroll; white-space: nowrap;
            scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; scrollbar-width: none;
            background: var(--bg-color); border-radius: 30px;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            display: flex; align-items: center; position: relative;
        }
        .minute-wheel-wrapper::-webkit-scrollbar { display: none; }
        .minute-wheel-wrapper::after {
            content: ''; position: absolute; left: 50%; bottom: 5px; width: 4px; height: 4px;
            background: var(--accent-color); border-radius: 50%; transform: translateX(-50%);
        }
        .min-item {
            display: inline-block; width: 60px; height: 60px; line-height: 60px;
            text-align: center; scroll-snap-align: center; font-size: 16px; color: var(--text-sub);
            flex-shrink: 0; transition: all 0.2s; opacity: 0.5;
        }
        .min-item.active { color: var(--accent-color); font-weight: bold; font-size: 22px; opacity: 1; transform: scale(1.2); }

        .task-preset-area { 
            height: 120px; position: relative; overflow: hidden; margin-bottom: 20px; flex-shrink: 0;
            mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
        }
        .wheel-container { height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; padding: 55px 0; scrollbar-width: none; }
        .wheel-container::-webkit-scrollbar { display: none; }

        .input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-shrink: 0; }
        .neu-input {
            flex: 1; padding: 15px; border-radius: 12px;
            background: var(--bg-color); border: none; outline: none;
            color: var(--text-main); font-size: 16px;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }
        .icon-btn {
            width: 50px; height: 50px; border-radius: 12px; background: var(--bg-color);
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            display: flex; justify-content: center; align-items: center; font-size: 20px; cursor: pointer; color: var(--text-sub);
            flex-shrink: 0;
        }
        .icon-btn:active { box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light); color: var(--accent-color); }

        .emoji-picker {
            display: none; grid-template-columns: repeat(6, 1fr); gap: 10px;
            padding: 10px; margin-bottom: 20px; max-height: 150px; overflow-y: auto;
            background: var(--bg-color); border-radius: 12px;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            flex-shrink: 0;
        }
        .emoji-item { font-size: 20px; text-align: center; cursor: pointer; padding: 5px; }

        .modal-buttons { display: flex; gap: 15px; margin-top: auto; }
        .modal-btn { 
            flex: 1; padding: 15px; border: none; border-radius: 12px;
            background: var(--bg-color); font-size: 16px; font-weight: 700; cursor: pointer;
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            color: var(--text-sub); transition: all 0.2s;
        }
        .modal-btn:active { box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light); }
        .modal-btn.save { color: var(--accent-color); }

        /* ì„¤ì • í† ê¸€ */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .setting-label { font-size: 16px; color: var(--text-main); }
        .neu-switch {
            position: relative; width: 50px; height: 26px;
            background: var(--bg-color); border-radius: 20px;
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            cursor: pointer; transition: all 0.3s;
        }
        .neu-switch::after {
            content: ''; position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; border-radius: 50%;
            background: #aaa; box-shadow: 2px 2px 4px var(--shadow-dark); transition: all 0.3s;
        }
        .neu-switch.checked { box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light); }
        .neu-switch.checked::after { left: 27px; background: var(--success-color); box-shadow: 0 0 10px var(--success-color); }

        .user-list-area { 
            padding: 15px; margin-bottom: 15px; border-radius: 12px;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            min-height: 50px; display: flex; flex-wrap: wrap; gap: 8px;
        }
        .user-chip { 
            padding: 8px 16px; border-radius: 20px; font-size: 14px; cursor: pointer;
            background: var(--bg-color); color: var(--text-sub);
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
        }
        .user-chip.current { color: var(--accent-color); font-weight: bold; }

    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="app-title">Todo Master</div>
        <div class="header-controls">
            <button class="neu-btn icon-only" onclick="openSettingsModal()">ğŸ””</button>
            <button class="neu-btn" id="userBtn" onclick="openUserModal()">
                <div class="user-status-dot" id="userStatusDot"></div>
                <span id="headerUserName">Guest</span>
            </button>
        </div>
    </div>

    <div class="date-picker-area">
        <div class="highlight-bar"></div>
        <div class="wheel-col" id="yearWheel"></div>
        <div class="wheel-col" id="monthWheel"></div>
        <div class="wheel-col" id="dayWheel"></div>
    </div>

    <div class="schedule-list" id="scheduleList"></div>
</div>

<div class="modal-overlay" id="taskModal">
    <div class="modal-box">
        <div class="time-setter-area">
            <div class="time-display">
                <span id="displayHour">00</span>
                <span style="opacity:0.3; margin-bottom:5px;">:</span>
                <span id="displayMin" class="active">00</span>
            </div>
            <div class="minute-wheel-wrapper" id="minuteWheel"></div>
        </div>
        
        <div class="task-preset-area">
            <div class="wheel-container" id="presetWheel"></div>
        </div>

        <div class="input-group">
            <input type="text" class="neu-input" id="taskInput" placeholder="í• ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off">
            <div class="icon-btn" onclick="toggleEmojiPicker()">â˜º</div>
        </div>
        
        <div class="emoji-picker" id="emojiPicker"></div>

        <div class="modal-buttons">
            <button class="modal-btn" onclick="closeTaskModal()">ì·¨ì†Œ</button>
            <button class="modal-btn save" onclick="saveTask()">ì €ì¥</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="userModal">
    <div class="modal-box">
        <h3 style="text-align:center; margin:0 0 20px 0;">ì‚¬ìš©ì ê³„ì •</h3>
        <div class="user-list-area" id="savedUserList"></div>
        <div class="input-group">
            <input type="text" class="neu-input" id="loginIdInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="modal-buttons" style="flex-direction: column; gap: 10px;">
            <button class="modal-btn save" onclick="handleLogin()">ë¡œê·¸ì¸ / ìƒì„±</button>
            <button class="modal-btn" onclick="handleLogout()" id="logoutBtn" style="color:var(--danger-color)">ë¡œê·¸ì•„ì›ƒ</button>
            <button class="modal-btn" onclick="closeUserModal()" style="margin-top:10px;">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal-box">
        <h3 style="text-align:center; margin:0 0 20px 0;">ì•Œë¦¼ ì„¤ì •</h3>
        <div class="setting-row">
            <span class="setting-label">ğŸ”Š ì†Œë¦¬ ì•Œë¦¼</span>
            <div class="neu-switch" id="toggleSound" onclick="toggleSetting('sound')"></div>
        </div>
        <div class="setting-row">
            <span class="setting-label">ğŸ”” í‘¸ì‹œ ì•Œë¦¼</span>
            <div class="neu-switch" id="toggleNoti" onclick="toggleSetting('noti')"></div>
        </div>
        <div class="modal-buttons" style="margin-top:20px;">
            <button class="modal-btn save" onclick="testAlarm()">í…ŒìŠ¤íŠ¸</button>
            <button class="modal-btn" onclick="closeSettingsModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ì„¤ì •
    const START_HOUR = 8;
    const END_HOUR = 24; 
    const PRESET_TASKS = ["(ì—†ìŒ)", "íšŒì˜", "ì—…ë¬´", "ì‹ì‚¬", "ìš´ë™", "íœ´ì‹", "ìŠ¤í„°ë””", "ì™¸ì¶œ", "ì´ë™", "ì·¨ì¹¨", "ì ê²€", "ë³´ê³ "];
    const EMOJIS = ["ğŸ˜€","ğŸ˜‚","ğŸ˜","ğŸ‘","ok","ğŸ”¥","âœ…","â¤ï¸","ğŸ˜­","ğŸ‰","âœˆï¸","ğŸ’Š","ğŸ¥","ğŸ“…","â­","â˜•","ğŸ”","ğŸº"];

    // ìƒíƒœ
    let currentUser = null;
    let todos = {}; 
    let settings = { sound: true, noti: true };
    let lastAlarmTime = "";

    // ë‚ ì§œ ìƒíƒœ (3ê°œì˜ íœ  ê°’)
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let currentDay = new Date().getDate();

    let editingHour = 0;
    let editingMin = 0;

    // DOM
    const yearWheel = document.getElementById('yearWheel');
    const monthWheel = document.getElementById('monthWheel');
    const dayWheel = document.getElementById('dayWheel');
    const scheduleList = document.getElementById('scheduleList');
    const minuteWheel = document.getElementById('minuteWheel');
    const emojiPicker = document.getElementById('emojiPicker');
    const taskInput = document.getElementById('taskInput');
    const userBtn = document.getElementById('userBtn');

    initData();
    initDateWheels(); // 3ë‹¨ íœ  ì´ˆê¸°í™”
    initPresetWheel();
    initMinuteWheel();
    initEmojiPicker();
    initSettings();
    startAlarmClock();

    function initData() {
        const list = localStorage.getItem('app_user_list');
        const last = localStorage.getItem('app_last_user');
        if(last && list && list.includes(last)) switchUser(last);
        else switchUser(null);
    }

    function initSettings() {
        const saved = localStorage.getItem('app_settings');
        if(saved) settings = JSON.parse(saved);
        updateSettingsUI();
    }

    // =========================================
    // 1. ë‚ ì§œ 3ë‹¨ íœ  ë¡œì§ (í•µì‹¬ ë³€ê²½)
    // =========================================
    function initDateWheels() {
        // ë…„ë„ (ì˜¬í•´ ê¸°ì¤€ -5ë…„ ~ +5ë…„)
        const startYear = currentYear - 5;
        const endYear = currentYear + 5;
        yearWheel.innerHTML = '';
        createPadding(yearWheel);
        for(let y = startYear; y <= endYear; y++) {
            createWheelItem(yearWheel, `${y}ë…„`, y);
        }
        createPadding(yearWheel);

        // ì›” (1~12)
        monthWheel.innerHTML = '';
        createPadding(monthWheel);
        for(let m = 1; m <= 12; m++) {
            createWheelItem(monthWheel, `${m}ì›”`, m);
        }
        createPadding(monthWheel);

        // ì¼ (ì´ˆê¸°í™”, updateDaysì—ì„œ ì±„ì›Œì§)
        updateDays(); // ìµœì´ˆ ì‹¤í–‰ìœ¼ë¡œ ì¼ ì±„ìš°ê¸°
        
        // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì—°ê²°
        setupDateWheelEvent(yearWheel, (val) => { currentYear = parseInt(val); updateDays(); });
        setupDateWheelEvent(monthWheel, (val) => { currentMonth = parseInt(val); updateDays(); });
        setupDateWheelEvent(dayWheel, (val) => { currentDay = parseInt(val); renderSchedule(); });

        // ì´ˆê¸° ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë§ì¶”ê¸° (ì˜¤ëŠ˜ ë‚ ì§œ)
        setTimeout(() => {
            scrollToValue(yearWheel, currentYear);
            scrollToValue(monthWheel, currentMonth);
            scrollToValue(dayWheel, currentDay);
            renderSchedule();
        }, 100);
    }

    // ì¼(Day) íœ  ì—…ë°ì´íŠ¸ (ë…„/ì›”ì´ ë°”ë€” ë•Œ ë§ˆë‹¤)
    function updateDays() {
        // í•´ë‹¹ ë…„/ì›”ì˜ ë§ˆì§€ë§‰ ë‚ ì§œ ê³„ì‚°
        const lastDay = new Date(currentYear, currentMonth, 0).getDate();
        
        // ê¸°ì¡´ ì„ íƒê°’ ìœ ì§€ (ë§Œì•½ 31ì¼ì´ì—ˆëŠ”ë° 30ì¼ë¡œ ì¤„ì–´ë“¤ë©´ 30ì¼ë¡œ ë³´ì •)
        if (currentDay > lastDay) currentDay = lastDay;

        // í˜„ì¬ DOM ìƒíƒœ í™•ì¸ (ì´ë¯¸ ê°¯ìˆ˜ê°€ ë§ë‹¤ë©´ ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•ŠìŒ - ì„±ëŠ¥ ìµœì í™”)
        // ë‹¤ë§Œ ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ë‹¤ì‹œ ê·¸ë¦¬ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ (ì•ˆì „ì„±)
        dayWheel.innerHTML = '';
        createPadding(dayWheel);
        for(let d = 1; d <= lastDay; d++) {
            createWheelItem(dayWheel, `${d}ì¼`, d);
        }
        createPadding(dayWheel);

        // ì¼ì íœ ì„ í˜„ì¬ ì„ íƒëœ ì¼ìë¡œ ìŠ¤í¬ë¡¤ (ë˜ëŠ” ë³´ì •ëœ ì¼ìë¡œ)
        setTimeout(() => {
             scrollToValue(dayWheel, currentDay);
             renderSchedule();
        }, 0);
    }

    function createWheelItem(container, text, val) {
        const div = document.createElement('div');
        div.className = 'wheel-item';
        div.textContent = text;
        div.dataset.value = val;
        div.onclick = () => div.scrollIntoView({behavior:'smooth', block:'center'});
        container.appendChild(div);
    }
    
    function createPadding(container) {
        // ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ íœ  ë†’ì´ì˜ ì ˆë°˜ ì •ë„ íŒ¨ë”©ì„ ì¤„ ìˆ˜ë„ ìˆì§€ë§Œ, 
        // CSSì—ì„œ padding: 55px 0 ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ìˆìœ¼ë¯€ë¡œ ë¹ˆ ìš”ì†ŒëŠ” ì„ íƒì‚¬í•­.
        // ìŠ¤í¬ë¡¤ ì˜ì—­ í™•ë³´ë¥¼ ìœ„í•´ ë§¨ìœ„/ì•„ë˜ ì—¬ë°±ìš© ë”ë¯¸ë¥¼ ë„£ëŠ” ê²ƒì´ ì¢‹ìŒ.
        const pad = document.createElement('div');
        pad.style.height = "55px"; 
        pad.style.flexShrink = "0";
        container.appendChild(pad);
    }

    // ê°’ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
    function scrollToValue(container, val) {
        const target = Array.from(container.children).find(c => c.dataset.value == val);
        if(target) target.scrollIntoView({block: 'center'});
    }

    // íœ  ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì…‹ì—…
    function setupDateWheelEvent(element, onSelect) {
        let timer;
        element.addEventListener('scroll', () => {
            clearTimeout(timer);
            // ì‹œê°ì  íš¨ê³¼ (3D)
            requestAnimationFrame(() => updateWheelVisuals(element));

            timer = setTimeout(() => {
                const selected = getCenterItem(element);
                if(selected && selected.dataset.value) {
                    selected.scrollIntoView({behavior:'smooth', block:'center'});
                    onSelect(selected.dataset.value);
                }
            }, 150); // ìŠ¤í¬ë¡¤ ë©ˆì¶¤ ê°ì§€
        });
        // ì´ˆê¸° ì‹œê° íš¨ê³¼
        setTimeout(() => updateWheelVisuals(element), 50);
    }

    function getCenterItem(container) {
        const center = container.scrollTop + container.offsetHeight / 2;
        let closest = null; let minDiff = Infinity;
        Array.from(container.children).forEach(child => {
            if(!child.dataset.value) return; // íŒ¨ë”© ì œì™¸
            const childCenter = child.offsetTop + child.offsetHeight / 2;
            const diff = Math.abs(center - childCenter);
            if(diff < minDiff) { minDiff = diff; closest = child; }
        });
        return closest;
    }

    function updateWheelVisuals(container) {
        const center = container.scrollTop + container.offsetHeight / 2;
        Array.from(container.children).forEach(child => {
            if(!child.dataset.value) return;
            const childCenter = child.offsetTop + child.offsetHeight / 2;
            const dist = center - childCenter; 
            const absDist = Math.abs(dist);
            
            // ì‹œê° íš¨ê³¼
            const scale = Math.max(0.7, 1 - absDist/500);
            const opacity = Math.max(0.2, 1 - absDist/100);
            
            child.style.transform = `scale(${scale})`;
            child.style.opacity = opacity;
            
            if(absDist < 20) child.classList.add('selected-visual');
            else child.classList.remove('selected-visual');
        });
    }

    function renderSchedule() {
        scheduleList.innerHTML = '';
        // í˜„ì¬ ì„ íƒëœ ë‚ ì§œ í‚¤ ìƒì„±
        const mStr = String(currentMonth).padStart(2,'0');
        const dStr = String(currentDay).padStart(2,'0');
        const selectedDateKey = `${currentYear}-${mStr}-${dStr}`;

        for(let h = START_HOUR; h <= END_HOUR; h++) {
            const key = `${selectedDateKey}-${h}`;
            let data = todos[key];
            let text = ""; let min = "00";
            if (typeof data === 'string') { text = data; } 
            else if (data) { text = data.text; min = String(data.min).padStart(2, '0'); }

            const div = document.createElement('div');
            div.className = 'time-slot';
            div.onclick = () => openTaskModal(h, min, text);
            const contentClass = text ? 'filled' : 'empty';
            div.innerHTML = `<div class="time-label">${h}:${min}</div><div class="task-content ${contentClass}">${text || 'í„°ì¹˜í•˜ì—¬ ì¼ì • ì¶”ê°€'}</div>`;
            scheduleList.appendChild(div);
        }
    }


    // =========================================
    // 2. ì•ŒëŒ ë° ê¸°íƒ€ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    // =========================================
    function startAlarmClock() {
        setInterval(() => {
            const now = new Date();
            const h = now.getHours();
            const m = now.getMinutes();
            const timeKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}-${h}`;
            const currentCheckKey = `${timeKey}:${m}`;
            if (lastAlarmTime === currentCheckKey) return;

            const todo = todos[timeKey];
            if (todo && typeof todo === 'object') {
                if (parseInt(todo.min) === m) {
                    triggerAlarm(todo.text);
                    lastAlarmTime = currentCheckKey;
                }
            }
        }, 3000);
    }

    function triggerAlarm(msg) {
        if (settings.sound) playChime();
        if (settings.noti) {
            if (Notification.permission === 'granted') {
                new Notification("Todo Master", { body: `[ì•Œë¦¼] ${msg}`, icon: '' });
            }
        }
    }

    function playChime() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(523.25, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1046.5, ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1.5);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 1.5);
    }

    window.testAlarm = () => triggerAlarm("ì•Œë¦¼ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.");
    window.openSettingsModal = () => { updateSettingsUI(); document.getElementById('settingsModal').style.display = 'flex'; };
    window.closeSettingsModal = () => document.getElementById('settingsModal').style.display = 'none';
    window.toggleSetting = (key) => {
        settings[key] = !settings[key];
        localStorage.setItem('app_settings', JSON.stringify(settings));
        updateSettingsUI();
        if(key === 'noti' && settings.noti) Notification.requestPermission();
    };
    function updateSettingsUI() {
        document.getElementById('toggleSound').className = `neu-switch ${settings.sound ? 'checked' : ''}`;
        document.getElementById('toggleNoti').className = `neu-switch ${settings.noti ? 'checked' : ''}`;
    }

    function initMinuteWheel() {
        minuteWheel.innerHTML = '';
        const pad = document.createElement('div'); pad.style.width = "calc(50% - 30px)"; pad.style.flexShrink="0";
        minuteWheel.appendChild(pad.cloneNode(true));
        for (let i = 0; i < 60; i++) {
            const span = document.createElement('span');
            span.className = 'min-item';
            span.textContent = String(i).padStart(2,'0');
            span.dataset.val = i;
            span.onclick = () => { span.scrollIntoView({behavior:'smooth', inline:'center'}); updateMinuteDisplay(i); }
            minuteWheel.appendChild(span);
        }
        minuteWheel.appendChild(pad.cloneNode(true));
        minuteWheel.addEventListener('scroll', () => {
            requestAnimationFrame(() => {
                const center = minuteWheel.scrollLeft + minuteWheel.offsetWidth / 2;
                let closest = null; let minDiff = Infinity;
                document.querySelectorAll('.min-item').forEach(item => {
                    const itemCenter = item.offsetLeft + item.offsetWidth / 2;
                    const diff = Math.abs(center - itemCenter);
                    if(diff < minDiff) { minDiff = diff; closest = item; }
                    item.classList.remove('active');
                });
                if(closest) {
                    closest.classList.add('active');
                    updateMinuteDisplay(parseInt(closest.dataset.val));
                }
            });
        });
    }

    function updateMinuteDisplay(m) {
        editingMin = m;
        document.getElementById('displayMin').textContent = String(m).padStart(2,'0');
    }
    
    function getCurrentSelectedMinute() {
        const center = minuteWheel.scrollLeft + minuteWheel.offsetWidth / 2;
        let closest = null; let minDiff = Infinity;
        document.querySelectorAll('.min-item').forEach(item => {
            const itemCenter = item.offsetLeft + item.offsetWidth / 2;
            const diff = Math.abs(center - itemCenter);
            if(diff < minDiff) { minDiff = diff; closest = item; }
        });
        return closest ? parseInt(closest.dataset.val) : 0;
    }

    function initPresetWheel() {
        const container = document.getElementById('presetWheel');
        PRESET_TASKS.forEach(t => {
            const d = document.createElement('div');
            d.className = 'wheel-item'; d.textContent = t; d.dataset.val = t;
            container.appendChild(d);
            d.onclick = () => d.scrollIntoView({behavior:'smooth', block:'center'});
        });
        setupVerticalWheel(container, (val) => { taskInput.value = (val === "(ì—†ìŒ)") ? "" : val; });
    }

    function initEmojiPicker() {
        EMOJIS.forEach(e => {
            const sp = document.createElement('div'); sp.className = 'emoji-item'; sp.textContent = e;
            sp.onclick = () => { taskInput.value += e; taskInput.focus(); };
            emojiPicker.appendChild(sp);
        });
    }
    window.toggleEmojiPicker = () => emojiPicker.style.display = (emojiPicker.style.display === 'grid') ? 'none' : 'grid';

    window.openTaskModal = (h, mStr, text) => {
        editingHour = h;
        const initialMin = parseInt(mStr);
        updateMinuteDisplay(initialMin);
        document.getElementById('displayHour').textContent = String(h).padStart(2,'0');
        taskInput.value = text;
        emojiPicker.style.display = 'none';
        document.getElementById('taskModal').style.display = 'flex';
        setTimeout(() => {
            const target = document.querySelector(`.min-item[data-val="${initialMin}"]`);
            if(target) target.scrollIntoView({inline:'center'});
        }, 100);
    };

    window.closeTaskModal = () => document.getElementById('taskModal').style.display = 'none';

    window.saveTask = () => {
        const val = taskInput.value.trim();
        const finalMin = getCurrentSelectedMinute();
        
        const mStr = String(currentMonth).padStart(2,'0');
        const dStr = String(currentDay).padStart(2,'0');
        const selectedDateKey = `${currentYear}-${mStr}-${dStr}`;
        const key = `${selectedDateKey}-${editingHour}`;
        
        if (val) {
            todos[key] = { text: val, min: finalMin };
        } else {
            if(todos[key] && confirm("ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) delete todos[key];
            else if(!todos[key]) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
        }
        if(currentUser) localStorage.setItem(`todo_data_${currentUser}`, JSON.stringify(todos));
        renderSchedule();
        closeTaskModal();
    };

    function switchUser(id) {
        currentUser = id;
        document.getElementById('headerUserName').textContent = id ? id : "Guest";
        if(id) {
            userBtn.classList.add('active-user');
            document.getElementById('userStatusDot').classList.add('active');
            document.getElementById('logoutBtn').style.display = 'block';
            const data = localStorage.getItem(`todo_data_${id}`);
            todos = data ? JSON.parse(data) : {};
            localStorage.setItem('app_last_user', id);
        } else {
            userBtn.classList.remove('active-user');
            document.getElementById('userStatusDot').classList.remove('active');
            document.getElementById('logoutBtn').style.display = 'none';
            todos = {};
            localStorage.removeItem('app_last_user');
        }
        renderSchedule();
    }

    function setupVerticalWheel(el, onSelect) {
        let timer;
        el.addEventListener('scroll', () => {
            requestAnimationFrame(() => updateWheelVisuals(el));
            clearTimeout(timer);
            timer = setTimeout(() => {
                const sel = getCenterItem(el);
                if(sel && onSelect) {
                    sel.scrollIntoView({behavior:'smooth', block:'center'});
                    onSelect(sel.dataset.value || sel.dataset.val);
                }
            }, 100);
        });
        setTimeout(() => updateWheelVisuals(el), 100);
    }

    window.openUserModal = () => {
        const listDiv = document.getElementById('savedUserList'); listDiv.innerHTML = '';
        const list = JSON.parse(localStorage.getItem('app_user_list') || '[]');
        if(list.length===0) listDiv.innerHTML = '<span style="color:var(--text-sub); font-size:13px;">ì—†ìŒ</span>';
        list.forEach(u => {
            const chip = document.createElement('span');
            chip.className = `user-chip ${u===currentUser?'current':''}`;
            chip.textContent = u;
            chip.onclick = () => { switchUser(u); closeUserModal(); };
            listDiv.appendChild(chip);
        });
        document.getElementById('userModal').style.display = 'flex';
    };
    window.closeUserModal = () => document.getElementById('userModal').style.display = 'none';
    window.handleLogin = () => {
        const name = document.getElementById('loginIdInput').value.trim();
        if(!name) return alert("ì´ë¦„ ì…ë ¥");
        let list = JSON.parse(localStorage.getItem('app_user_list') || '[]');
        if(!list.includes(name)) { list.push(name); localStorage.setItem('app_user_list', JSON.stringify(list)); }
        switchUser(name);
        document.getElementById('loginIdInput').value = '';
        closeUserModal();
    };
    window.handleLogout = () => {
        if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { switchUser(null); closeUserModal(); }
    };
});
</script>
</body>
</html>
